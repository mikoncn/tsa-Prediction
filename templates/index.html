<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TSA 旅客吞吐量历史数据</title>
    <!-- Chart.js Core -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Date Adapter -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <!-- Hammer.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <!-- Zoom Plugin -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/2.0.1/chartjs-plugin-zoom.min.js"></script>
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max_width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .controls {
            margin-bottom: 20px;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        button, select {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: #fff;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
            transition: all 0.2s;
        }
        button:hover, button.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        select {
            min-width: 100px;
        }
        select:focus {
            border-color: #007bff;
            outline: none;
        }
        .chart-container {
            position: relative;
            height: 600px;
            width: 100%;
            cursor: crosshair;
        }
        canvas {
            width: 100% !important;
            height: 100% !important;
        }
        .stats {
            margin-top: 20px;
            display: flex;
            justify-content: space-around;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        .stat-item {
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
        .hint {
            text-align: center;
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }
        .divider {
            width: 1px;
            height: 24px;
            background: #ddd;
            margin: 0 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>TSA 旅客吞吐量历史趋势</h1>
        
        <div class="controls">
            <!-- 快捷按钮 -->
            <button onclick="setQuickRange('all')" class="active" id="btn-all">全部数据</button>
            <button onclick="setQuickRange('14d')" id="btn-14d">最近 14 天</button>
            <button onclick="setQuickRange('7d')" id="btn-7d">最近 7 天</button>
            
            <div class="divider"></div>

            <!-- 级联筛选 -->
            <select id="yearSelect" onchange="applyFilters()">
                <option value="all">所有年份</option>
            </select>
            
            <select id="monthSelect" onchange="applyFilters()">
                <option value="all">全年</option>
                <option value="01">1月</option>
                <option value="02">2月</option>
                <option value="03">3月</option>
                <option value="04">4月</option>
                <option value="05">5月</option>
                <option value="06">6月</option>
                <option value="07">7月</option>
                <option value="08">8月</option>
                <option value="09">9月</option>
                <option value="10">10月</option>
                <option value="11">11月</option>
                <option value="12">12月</option>
            </select>

            <button onclick="resetZoom()" style="margin-left: 20px; border-color: #666;">重置缩放</button>
        </div>

        <div class="chart-container">
            <canvas id="trafficChart"></canvas>
        </div>
        <p class="hint">提示：在图表上使用鼠标滚轮缩放，按住鼠标左键可左右拖动时间轴。</p>

        <div class="stats">
            <div class="stat-item">
                <div class="stat-value" id="latest-val">-</div>
                <div class="stat-label">最新单日客流</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="max-val">-</div>
                <div class="stat-label">历史峰值</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="avg-val">-</div>
                <div class="stat-label">当前显示平均值</div>
            </div>
        </div>
    </div>

    <script>
        let chart;
        let allData = [];
        let availableYears = new Set();

        // 初始化图表
        function initChart() {
            const ctx = document.getElementById('trafficChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: '旅客吞吐量',
                        data: [],
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3,
                        pointRadius: 2,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index',
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'month',
                                displayFormats: {
                                    month: 'yyyy年MM月',
                                    day: 'MM-dd (EEE)'
                                },
                                tooltipFormat: 'yyyy-MM-dd'
                            },
                            title: {
                                display: true,
                                text: '日期'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: '人次'
                            },
                            ticks: {
                                callback: function(value) {
                                    return (value / 1000000).toFixed(1) + 'M';
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    const date = new Date(context[0].parsed.x);
                                    return new Intl.DateTimeFormat('zh-CN', { 
                                        year: 'numeric', 
                                        month: '2-digit', 
                                        day: '2-digit', 
                                        weekday: 'short' 
                                    }).format(date);
                                },
                                label: function(context) {
                                    return ' 旅客: ' + new Intl.NumberFormat().format(context.parsed.y);
                                }
                            }
                        },
                        zoom: {
                            pan: {
                                enabled: true,
                                mode: 'x', 
                                modifierKey: null, 
                            },
                            zoom: {
                                wheel: {
                                    enabled: true,
                                },
                                pinch: {
                                    enabled: true
                                },
                                mode: 'x', 
                            },
                            limits: {
                                x: {min: 'original', max: 'original'}
                            }
                        }
                    }
                }
            });
        }

        // 加载数据
        async function loadData() {
            try {
                const response = await fetch('/api/data');
                const data = await response.json();
                
                // 转换数据格式
                allData = data.map(item => ({
                    x: item.date,
                    y: item.throughput
                }));

                // 提取年份用于下拉框
                allData.forEach(item => {
                    const year = item.x.split('-')[0];
                    availableYears.add(year);
                });
                populateYearSelect();

                // 默认显示全部
                updateChart(allData);
                updateStats(allData);
                
            } catch (error) {
                console.error('Error loading data:', error);
                alert('加载数据失败，请检查后端服务是否启动。');
            }
        }

        // 填充年份下拉框
        function populateYearSelect() {
            const select = document.getElementById('yearSelect');
            // 排序年份 (降序)
            const sortedYears = Array.from(availableYears).sort((a, b) => b - a);
            
            sortedYears.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year + '年';
                select.appendChild(option);
            });
        }

        // 更新图表数据
        function updateChart(data) {
            chart.data.datasets[0].data = data;
            
            // 自动调整 x 轴单位
            if (data.length <= 60) {
                 chart.options.scales.x.time.unit = 'day';
            } else {
                 chart.options.scales.x.time.unit = 'month';
            }
            
            chart.update();
            chart.resetZoom();
        }

        function resetZoom() {
            chart.resetZoom();
        }

        // 快捷范围选择
        function setQuickRange(range) {
            // UI 状态
            document.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
            const btn = document.getElementById(`btn-${range}`);
            if (btn) btn.classList.add('active');
            
            // 重置下拉框
            document.getElementById('yearSelect').value = 'all';
            document.getElementById('monthSelect').value = 'all';

            if (range === 'all') {
                updateChart(allData);
                updateStats(allData);
            } else {
                const now = new Date();
                let cutoffDate = new Date();
                
                if (range === '14d') {
                    cutoffDate.setDate(now.getDate() - 14);
                } else if (range === '7d') {
                    cutoffDate.setDate(now.getDate() - 7);
                }

                const filteredData = allData.filter(item => new Date(item.x) >= cutoffDate);
                updateChart(filteredData);
                updateStats(filteredData);
            }
        }

        // 级联筛选逻辑
        function applyFilters() {
            // 清除快捷按钮状态
            document.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));

            const selectedYear = document.getElementById('yearSelect').value;
            const selectedMonth = document.getElementById('monthSelect').value;

            let filteredData = allData;

            // 1. 年份筛选
            if (selectedYear !== 'all') {
                filteredData = filteredData.filter(item => item.x.startsWith(selectedYear));
            }

            // 2. 月份筛选
            if (selectedMonth !== 'all') {
                // 如果选了特定年份，匹配 YYYY-MM
                // 如果只选了月份（所有年份的该月），匹配 -MM-
                if (selectedYear !== 'all') {
                    const prefix = `${selectedYear}-${selectedMonth}`;
                    filteredData = filteredData.filter(item => item.x.startsWith(prefix));
                } else {
                    // 没有选年份，但选了月份 -> 显示历年该月数据 (可选功能，这里按逻辑实现)
                    const monthStr = `-${selectedMonth}-`;
                    filteredData = filteredData.filter(item => item.x.includes(monthStr));
                }
            }

            updateChart(filteredData);
            updateStats(filteredData);
        }

        // 更新统计信息
        function updateStats(data) {
            if (data.length === 0) {
                document.getElementById('latest-val').textContent = '-';
                document.getElementById('max-val').textContent = '-';
                document.getElementById('avg-val').textContent = '-';
                return;
            }

            // 最新值 (当前筛选范围内的最后一个点)
            const latest = data[data.length - 1].y;
            document.getElementById('latest-val').textContent = new Intl.NumberFormat().format(latest);

            // 峰值
            const max = Math.max(...data.map(d => d.y));
            document.getElementById('max-val').textContent = new Intl.NumberFormat().format(max);

            // 平均值
            const avg = data.reduce((a, b) => a + b.y, 0) / data.length;
            document.getElementById('avg-val').textContent = new Intl.NumberFormat().format(Math.round(avg));
        }

        // 启动
        initChart();
        loadData();
    </script>
</body>
</html>
