<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TSA æ—…å®¢ååé‡å†å²æ•°æ®</title>
    <!-- å¼•å…¥å¤–éƒ¨æ ·å¼ -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    
    <!-- ä¾èµ–åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/2.0.1/chartjs-plugin-zoom.min.js"></script>
    <!-- Annotation Plugin (å…³é”®: å¿…é¡»å¼•å…¥) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/3.0.1/chartjs-plugin-annotation.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>TSA æ—…å®¢ååé‡ - Mikon AI Scout</h1>
        
        <div class="controls">
            <!-- å¿«æ·æŒ‰é’® -->
            <button onclick="setQuickRange(365)" class="active">æœ€è¿‘1å¹´</button>
            <button onclick="setQuickRange(180)">æœ€è¿‘åŠå¹´</button>
            <button onclick="setQuickRange(30)">æœ€è¿‘30å¤©</button>
            
            <div class="divider"></div>
            
            <button id="btnRunPred" onclick="runPrediction()" style="background-color: #28a745; color: white;">ğŸš€ ç«‹å³é¢„æµ‹</button>
            <button id="btnUpdateData" onclick="updateData()" style="background-color: #17a2b8; color: white; margin-left: 10px;">ğŸ”„ æ›´æ–°æ•°æ®</button>
            <button id="btnRunSniper" onclick="runSniperModel()" style="background-color: #dc3545; color: white; margin-left: 10px; font-weight: bold;">ğŸ¯ æ™ºèƒ½ç‹™å‡» (Smart Sniper)</button>
            
            <!-- [NEW] Challenger Button -->
            <button id="btnChallenger" onclick="runChallenger()" style="background-color: #6f42c1; color: white; margin-left: 10px; font-weight: bold;">ğŸŸ£ æ·±åº¦å¯¹å†³ (Deep Comparison)</button>

            <!-- å¹´ä»½ç­›é€‰ -->
            <select id="yearSelect">
                <!-- JS åŠ¨æ€å¡«å…… -->
            </select>

            <button onclick="chart.resetZoom()" style="margin-left: 20px;">é‡ç½®ç¼©æ”¾</button>
        </div>

        <div class="chart-container">
            <canvas id="trafficChart"></canvas>
        </div>
        <p class="hint">ğŸ–±ï¸ æç¤ºï¼šç‚¹å‡»çº¢ç‚¹æŸ¥çœ‹è¯¦æƒ… | æ»šè½®ç¼©æ”¾ | æ‹–æ‹½å¹³ç§»</p>
        
        <!-- ç‹™å‡»æ¨¡å‹ç»“æœæ¨¡æ€æ¡† -->
        <div id="sniperModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
            <div style="background: white; padding: 30px; border-radius: 8px; width: 400px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <h2 style="color: #dc3545;">ğŸ¯ ç‹™å‡»æ¨¡å‹ç»“æœ (Sniper)</h2>
                <div style="margin: 20px 0; border-bottom: 1px solid #eee; padding-bottom: 20px;">
                    <p style="font-size: 1.1em; color: #666;">ç›®æ ‡æ—¥æœŸ: <span id="sniperDate" style="font-weight: bold;">-</span></p>
                    <h1 id="sniperValue" style="font-size: 2.5em; color: #007bff; margin: 10px 0;">-</h1>
                    <p style="color: #666;">å®æ—¶é£è¡Œé‡: <span id="sniperFlights" style="font-weight: bold;">-</span> æ¶æ¬¡</p>
                </div>
                <div id="sniperBadge" style="background: #28a745; color: white; padding: 5px 10px; border-radius: 4px; display: inline-block; font-size: 0.9em;">âœ… å®æ—¶åŒæ­¥ (High Precision)</div>
                <button onclick="document.getElementById('sniperModal').style.display = 'none'" style="margin-top: 25px; padding: 10px 30px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">å…³é—­</button>
            </div>
        </div>

        <!-- ç»Ÿè®¡é¢æ¿ (IDs å¿…é¡»ä¸ dashboard.js ä¸€è‡´) -->
        <div class="stats-panel" style="display: flex; justify-content: space-around; margin-top: 20px; text-align: center;">
            <div class="stat-card">
                <h3>æœ€æ–°å®¢æµ (<span id="latestDate">-</span>)</h3>
                <div class="value" id="latestPassengers" style="font-size: 1.5em; font-weight: bold; color: #007bff;">-</div>
            </div>
            <div class="stat-card">
                <h3>å‰æ—¥å®¢æµ (<span id="prevDate">-</span>)</h3>
                <div class="value" id="prevPassengers" style="font-size: 1.5em; font-weight: bold; color: #6c757d;">-</div>
            </div>
            <div class="stat-card" style="border: 2px solid #28a745; background: #f0fff4; min-width: 250px;">
                <h3>
                    é¢„æµ‹å®¢æµ 
                    <select id="predDateSelect" style="font-size: 0.8em; padding: 2px; margin-left: 5px; border-radius: 4px; border: 1px solid #ccc;">
                        <option value="">Loading...</option>
                    </select>
                </h3>
                <div class="value" id="predPassengers" style="font-size: 1.5em; font-weight: bold; color: #28a745;">Loading...</div>
            </div>
        </div>

        <!-- é¢„æµ‹å›æµ‹è¡¨æ ¼ & ç”Ÿæ•°æ®é¢æ¿ -->
        <div class="review-panel" style="margin-top: 40px;">

            <div class="panel-tabs" style="display: flex; gap: 20px; border-bottom: 2px solid #eee; margin-bottom: 20px;">
                <h2 id="tab-btn-validation" onclick="switchTab('validation')" style="border-left: 5px solid #28a745; padding-left: 10px; cursor: pointer; margin-bottom: 10px; opacity: 1;">ğŸ›¡ï¸ æ¨¡å‹å®æˆ˜å›æµ‹</h2>
                <h2 id="tab-btn-rawdata" onclick="switchTab('rawdata')" style="border-left: 5px solid #ccc; padding-left: 10px; cursor: pointer; margin-bottom: 10px; opacity: 0.5;">ğŸ§¬ å…¨æ¯ç”Ÿæ•°æ® (Raw Matrix)</h2>
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <h2 id="tab-btn-polymarket" onclick="switchTab('polymarket')" style="border-left: 5px solid #ccc; padding-left: 10px; cursor: pointer; margin-bottom: 0; opacity: 0.5;">ğŸ”® å¸‚åœºé¢„æµ‹ (Sentiment)</h2>
                    <button id="btnSyncSentiment" onclick="syncSentiment()" style="display:none; background: #6f42c1; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 14px;" title="å®æ—¶åˆ·æ–°èµ”ç‡">ğŸ”„</button>
                </div>
            </div>

            <!-- Tab 1: Validation -->
            <div id="tab-validation" style="display: block;">
                <div style="overflow-x: auto; max-height: 500px; overflow-y: auto; border: 1px solid #dee2e6;">
                    <table id="accuracyTable" style="width: 100%; border-collapse: collapse; margin-top: 0;">
                        <thead>
                            <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6; position: sticky; top: 0; z-index: 1;">
                                <th style="padding: 12px; text-align: left;">æ—¥æœŸ</th>
                                <th style="padding: 12px; text-align: right;">çœŸå®å®¢æµ</th>
                                <th style="padding: 12px; text-align: right;">AI é¢„æµ‹</th>
                                <th style="padding: 12px; text-align: right;">è¯¯å·® (äººæ•°)</th>
                                <th style="padding: 12px; text-align: center;">å‡†ç¡®åº¦</th>
                            </tr>
                        </thead>
                        <tbody id="accuracyTableBody">
                            <!-- JS å¡«å…… -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tab 2: Raw Data -->
            <div id="tab-rawdata" style="display: none;">
                <div class="glass-scroll" style="overflow-x: auto; max-height: 600px; overflow-y: auto;">
                    <table id="rawTable">
                        <thead>
                            <tr>
                                <th style="padding: 10px;">æ—¥æœŸ (Date)</th>
                                <th style="padding: 10px; text-align: right;">å®¢æµé‡ (Throughput)</th>
                                <th style="padding: 10px;">èŠ‚å‡æ—¥ (Holiday)</th>
                                <th style="padding: 10px;">æ°”è±¡å› å­ (Weather)</th>
                                <th style="padding: 10px;">èˆªç­å› å­ (Flight)</th>
                                <th style="padding: 10px;">æ—¶åºé”šç‚¹ (Lags)</th>
                            </tr>
                        </thead>
                        <tbody id="rawTableBody">
                            <!-- JS å¡«å…… -->
                        </tbody>
                    </table>
                </div>
                <!-- Load More Button -->
                <div style="text-align: center; margin-top: 15px;">
                    <button onclick="loadRawData()" style="padding: 10px 30px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer;">â¬‡ï¸ åŠ è½½æ›´å¤š (Load More 50)</button>
                </div>
            </div>

            <!-- Tab 3: Polymarket (New) -->
            <div id="tab-polymarket" style="display: none;">
                <div id="polymarket-grid">
                    <!-- Cards injected by JS -->
                </div>
            </div>


<!-- Scoped CSS for Polymarket Cards -->
<style>
    #polymarket-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 20px;
        padding: 10px;
    }
    .market-card {
        border: 1px solid #e9ecef;
        border-radius: 12px;
        padding: 15px;
        background: #fff;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        transition: transform 0.2s;
    }
    .market-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .market-header {
        margin-bottom: 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #f8f9fa;
        padding-bottom: 8px;
    }
    .market-date {
        font-size: 1.1em;
        font-weight: 700;
        color: #343a40;
    }
    .view-details-btn {
        font-size: 0.85em;
        color: #6f42c1;
        text-decoration: none;
        background: #f3f0ff;
        padding: 4px 10px;
        border-radius: 12px;
        font-weight: 500;
    }
    .view-details-btn:hover {
        background: #e0d4fc;
        text-decoration: none;
    }
    
    /* New Layout: Bucket Chips (Small Boxes) */
    .bucket-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }
    .bucket-chip {
        flex: 1 1 30%; /* Approx 3 per row, responsive */
        min-width: 90px;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 8px;
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
    .chip-prob {
        font-size: 1.2em;
        font-weight: 800;
        color: #495057;
    }
    .chip-label {
        font-size: 0.8em;
        color: #6c757d;
        margin-top: 2px;
    }
    
    /* Winner Style */
    .bucket-chip.winner {
        background: #d4edda;
        border-color: #c3e6cb;
    }
    .bucket-chip.winner .chip-prob {
        color: #155724;
    }
    .bucket-chip.winner .chip-label {
        color: #155724;
    }
</style>
                </div>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥å¤–éƒ¨é€»è¾‘ -->
    <script src="{{ url_for('static', filename='js/dashboard.js') }}?v={{ range(1, 10000) | random }}"></script>
</body>
</html>
