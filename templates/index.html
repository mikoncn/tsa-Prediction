<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TSA æ—…å®¢ååé‡ - Mikon AI Scout (Vue)</title>
    <!-- å¼•å…¥å¤–éƒ¨æ ·å¼ -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    
    <!-- ä¾èµ–åº“ (Chart.js need to be global for the component wrapper to find it easily, or import in component) -->
    <!-- Since we are using ESM for Vue, we can load Chart.js via CDN in head global or import in component. 
         My component code uses `new Chart()`, implying global. -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/2.0.1/chartjs-plugin-zoom.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/3.0.1/chartjs-plugin-annotation.min.js"></script>

    <style>
        [v-cloak] { display: none; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.5s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
    </style>
</head>
<body>
{% raw %}
    <div id="app" class="container" v-cloak>
        <h1>TSA æ—…å®¢ååé‡ - Mikon AI Scout</h1>
        
        <!-- Controls Component -->
        <control-panel 
            :years="years"
            @update-range="setQuickRange"
            @run-prediction="runPrediction"
            @update-data="updateData"
            @run-sniper="runSniper"
            @run-challenger="runChallenger"
            @filter-year="filterYear"
            @reset-zoom="chartRef && chartRef.resetZoom()"
        ></control-panel>

        <!-- Chart Component -->
        <traffic-chart 
            ref="chartRef"
            :chart-data="currentChartData"
            :predictions="predictions"
            :challenger-data="challengerData"
            :annotations="currentAnnotations"
        ></traffic-chart>
        
        <p class="hint">ğŸ–±ï¸ æç¤ºï¼šç‚¹å‡»çº¢ç‚¹æŸ¥çœ‹è¯¦æƒ… | æ»šè½®ç¼©æ”¾ | æ‹–æ‹½å¹³ç§»</p>
        
        <!-- Sniper Modal (Inline) -->
        <div v-if="showSniperModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">
            <div style="background: white; padding: 30px; border-radius: 8px; width: 400px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <h2 style="color: #dc3545;">ğŸ¯ ç‹™å‡»æ¨¡å‹ç»“æœ (Sniper)</h2>
                <div style="margin: 20px 0; border-bottom: 1px solid #eee; padding-bottom: 20px;">
                    <p style="font-size: 1.1em; color: #666;">ç›®æ ‡æ—¥æœŸ: <span style="font-weight: bold;">{{ sniperResult.date }}</span></p>
                    <h1 style="font-size: 2.5em; color: #007bff; margin: 10px 0;">{{ (sniperResult.value / 1000000).toFixed(2) }}M</h1>
                    <p style="color: #666;">å®æ—¶é£è¡Œé‡: <span style="font-weight: bold;">{{ sniperResult.flights.toLocaleString() }}</span> æ¶æ¬¡</p>
                </div>
                <div :style="{ background: sniperResult.is_fallback ? '#ffc107' : '#28a745', color: sniperResult.is_fallback ? '#000' : '#fff' }" style="padding: 5px 10px; border-radius: 4px; display: inline-block; font-size: 0.9em;">
                    {{ sniperResult.is_fallback ? 'âš ï¸ é™çº§æ¨¡å¼ (Fallback)' : 'âœ… å®æ—¶åŒæ­¥ (High Precision)' }}
                </div>
                <button @click="showSniperModal = false" style="margin-top: 25px; padding: 10px 30px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">å…³é—­</button>
            </div>
        </div>
        
        <!-- Export Modal (Inline) -->
        <div v-if="showModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px);">
            <div style="background: white; padding: 35px; border-radius: 16px; width: 450px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.2); border: 1px solid #eee;">
                <div style="font-size: 50px; margin-bottom: 20px;">ğŸ“¥</div>
                <h2 style="margin-bottom: 15px; color: #333;">å¯¼å‡ºé¢„æµ‹æ¸…å•</h2>
                <p style="color: #666; font-size: 1.1em; line-height: 1.6; margin-bottom: 30px;">
                    å³å°†ç”Ÿæˆå¹¶ä¸‹è½½æœ€æ–°çš„<span style="color: #28a745; font-weight: bold;">â€œå¾…è¯å®å®¢æµé¢„æµ‹æ¸…å•â€</span>ã€‚<br>
                    æ ¼å¼ä¸º TXTï¼ŒåŒ…å«æ‰€æœ‰å°šæœªå…¬å¸ƒå®é™…å€¼çš„æœªæ¥é¢„åˆ¤ã€‚
                </p>
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <a :href="'/api/v2/secure_export?t=' + Date.now()" @click="showModal = false" target="_blank" style="padding: 12px 35px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1em; text-decoration: none;">ç¡®è®¤å¯¼å‡º</a>
                    <button @click="showModal = false" style="padding: 12px 35px; background: #f8f9fa; color: #666; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1em;">å–æ¶ˆ</button>
                </div>
            </div>
        </div>

        <!-- Stats Panel -->
        <stats-panel 
            :stats="stats" 
            :prediction="predictionState" 
            :weekly-state="weeklyState"
            @update:selected-date="onPredictionDateChange"
            @update-weekly="updateWeeklyState"
        ></stats-panel>

        <!-- [NEW] Weekly Breakdown Visualization -->
        <div v-if="weeklyState.breakdown && weeklyState.breakdown.length > 0" 
             style="background: white; padding: 20px; border-radius: 12px; margin-top: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.05);">
            
            <h3 style="margin: 0 0 15px 0; font-size: 1.1em; color: #666; display: flex; align-items: center; justify-content: space-between;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span>ğŸ§® å‘¨åº¦å®¢æµè®¡ç®—è¯¦æƒ…</span>
                    <!-- [NEW] Week Selector Dropdown -->
                    <select v-model="weeklyState.selected" @change="updateWeeklyState($event.target.value)" 
                            style="background: #f8f9fa; border: 1px solid #ddd; padding: 4px 8px; border-radius: 6px; font-size: 0.8em; color: #333; outline: none; cursor: pointer;">
                        <option v-for="opt in weeklyState.options" :key="opt.value" :value="opt.value">
                            {{ opt.label }}
                        </option>
                    </select>
                </div>
                
                <!-- [NEW] Challenger Toggle -->
                <div style="font-size: 0.6em; display: flex; align-items: center; gap: 10px;">
                    <label style="cursor: pointer; display: flex; align-items: center; gap: 5px; user-select: none;">
                        <input type="checkbox" v-model="weeklyState.showChallenger" :disabled="!challengerData.length">
                        <span :style="{ color: weeklyState.showChallenger ? '#6f42c1' : '#666', fontWeight: weeklyState.showChallenger ? 'bold' : 'normal' }">
                            âš”ï¸ å¯¹æ¯”æŒ‘æˆ˜è€… (Compare Challenger)
                        </span>
                    </label>
                </div>
            </h3>

            <!-- Row 1: Standard Forecast -->
            <div style="display: flex; flex-wrap: nowrap; align-items: center; gap: 8px; font-family: 'SF Mono', Consolas, monospace; font-size: 0.9em; margin-bottom: 10px; overflow-x: auto; padding-bottom: 5px;">
                
                <template v-for="(item, index) in weeklyState.breakdown" :key="item.date">
                    
                    <!-- Plus Sign -->
                    <span v-if="index > 0" style="color: #ccc; font-weight: bold;">+</span>

                    <!-- Data Item -->
                    <div style="display: flex; flex-direction: column; align-items: center; background: #f8f9fa; padding: 4px 10px; border-radius: 6px;">
                        <span style="font-size: 0.7em; color: #999; margin-bottom: 2px;">{{ item.label }}</span>
                        <!-- Blue for History, Orange for Prediction -->
                        <span :style="{ color: item.type === 'history' ? '#007bff' : (item.type === 'sniper' ? '#dc3545' : '#fd7e14'), fontWeight: 'bold' }">
                            {{ item.value.toLocaleString() }}
                        </span>
                    </div>

                </template>

                <!-- Equals Sign -->
                <span style="color: #ccc; font-weight: bold; margin: 0 5px;">=</span>

                <!-- Total -->
                <div style="display: flex; flex-direction: column; align-items: center; background: #e8f5e9; padding: 4px 12px; border-radius: 6px; border: 1px solid #c3e6cb;">
                   <span style="font-size: 0.75em; color: #28a745; margin-bottom: 2px;">Total</span>
                   <span style="color: #28a745; font-weight: bold; font-size: 1.05em;">
                       {{ weeklyState.sum ? weeklyState.sum.toLocaleString() : '...' }}
                   </span>
                </div>

                <!-- [NEW] Probability Ranges (Standard) -->
                <div v-if="weeklyState.ranges.standard && weeklyState.ranges.standard.maxError" 
                     style="margin-left: 20px; display: flex; gap: 10px; border-left: 2px solid #eee; padding-left: 20px;">
                    <div style="background: #fffde7; padding: 4px 12px; border-radius: 6px; border: 1px dashed #fbc02d; font-size: 0.85em;">
                        <div style="color: #f57f17; font-weight: bold; margin-bottom: 2px;">âš ï¸ æœ€å¤§è¯¯å·®å¯èƒ½æ€§ (Max Error Range)</div>
                        <div style="font-family: monospace; color: #333;">
                            {{ weeklyState.ranges.standard.maxError.min.toLocaleString() }} ~ {{ weeklyState.ranges.standard.maxError.max.toLocaleString() }}
                        </div>
                    </div>
                    <div style="background: #f1f8e9; padding: 4px 12px; border-radius: 6px; border: 1px dashed #8bc34a; font-size: 0.85em;">
                        <div style="color: #558b2f; font-weight: bold; margin-bottom: 2px;">ğŸ¯ å¹³å‡è¯¯å·®å¯èƒ½æ€§ (Avg Error Range)</div>
                        <div style="font-family: monospace; color: #333;">
                            {{ weeklyState.ranges.standard.avgError.min.toLocaleString() }} ~ {{ weeklyState.ranges.standard.avgError.max.toLocaleString() }}
                        </div>
                    </div>
                </div>

            </div>
            
            <!-- Row 2: Challenger Forecast (Comparison) -->
            <div v-if="weeklyState.showChallenger" style="display: flex; flex-wrap: nowrap; align-items: center; gap: 8px; font-family: 'SF Mono', Consolas, monospace; font-size: 0.9em; margin-top: 15px; border-top: 1px dashed #ddd; padding-top: 15px; overflow-x: auto; padding-bottom: 5px;">
                
                <template v-for="(item, index) in weeklyState.challengerBreakdown" :key="item.date + '_c'">
                    
                    <!-- Plus Sign -->
                    <span v-if="index > 0" style="color: #ccc; font-weight: bold;">+</span>

                    <!-- Data Item -->
                    <div style="display: flex; flex-direction: column; align-items: center; background: #f8f9fa; padding: 4px 10px; border-radius: 6px; border-bottom: 2px solid transparent;"
                         :style="{ borderColor: item.type === 'challenger' ? '#6f42c1' : 'transparent' }">
                        <span style="font-size: 0.7em; color: #999; margin-bottom: 2px;">{{ item.label }}</span>
                        <!-- Purple for Challenger, else matches Row 1 -->
                        <span :style="{ color: item.type === 'history' ? '#007bff' : (item.type === 'sniper' ? '#dc3545' : (item.type === 'challenger' ? '#6f42c1' : '#fd7e14')), fontWeight: 'bold' }">
                            {{ item.value.toLocaleString() }}
                        </span>
                    </div>

                </template>

                <!-- Equals Sign -->
                <span style="color: #ccc; font-weight: bold; margin: 0 5px;">=</span>

                <!-- Total -->
                <div style="display: flex; flex-direction: column; align-items: center; background: #f3e5f5; padding: 4px 12px; border-radius: 6px; border: 1px solid #e1bee7;">
                   <span style="font-size: 0.75em; color: #6f42c1; margin-bottom: 2px;">Challenger Total</span>
                   <span style="color: #6f42c1; font-weight: bold; font-size: 1.05em;">
                       {{ weeklyState.challengerSum ? weeklyState.challengerSum.toLocaleString() : '...' }}
                   </span>
                </div>

                <!-- [NEW] Probability Ranges (Challenger) -->
                <div v-if="weeklyState.ranges.challenger && weeklyState.ranges.challenger.maxError" 
                     style="margin-left: 20px; display: flex; gap: 10px; border-left: 2px solid #eee; padding-left: 20px;">
                    <div style="background: #fff3e0; padding: 4px 12px; border-radius: 6px; border: 1px dashed #ffa000; font-size: 0.85em;">
                        <div style="color: #e65100; font-weight: bold; margin-bottom: 2px;">âš”ï¸ æŒ‘æˆ˜è€…æœ€å¤§è¯¯å·®</div>
                        <div style="font-family: monospace; color: #333;">
                            {{ weeklyState.ranges.challenger.maxError.min.toLocaleString() }} ~ {{ weeklyState.ranges.challenger.maxError.max.toLocaleString() }}
                        </div>
                    </div>
                </div>
                
                <!-- Delta Badge -->
                <div v-if="weeklyState.sum && weeklyState.challengerSum" 
                     :style="{ color: (weeklyState.challengerSum - weeklyState.sum) > 0 ? '#28a745' : '#dc3545' }"
                     style="font-size: 0.9em; font-weight: bold; margin-left: 10px;">
                     {{ (weeklyState.challengerSum - weeklyState.sum) > 0 ? '+' : '' }}{{ (weeklyState.challengerSum - weeklyState.sum).toLocaleString() }}
                </div>

            </div>
            
            <!-- Legend -->
            <div style="margin-top: 12px; font-size: 0.8em; color: #999; display: flex; gap: 15px;">
                <span style="display: flex; align-items: center; gap: 5px;">
                    <span style="width: 8px; height: 8px; background: #007bff; border-radius: 50%;"></span> ç”±å·²æœ‰æ•°æ®æä¾› (Actual)
                </span>
                <span style="display: flex; align-items: center; gap: 5px;">
                    <span style="width: 8px; height: 8px; background: #dc3545; border-radius: 50%;"></span> ç‹™å‡»æ¨¡å‹é¢„æµ‹ (Sniper)
                </span>
                <span style="display: flex; align-items: center; gap: 5px;">
                    <span style="width: 8px; height: 8px; background: #fd7e14; border-radius: 50%;"></span> ç”± AI æ¨¡å‹é¢„æµ‹ (Prediction)
                </span>
                <span style="display: flex; align-items: center; gap: 5px;">
                    <span style="width: 8px; height: 8px; background: #6f42c1; border-radius: 50%;"></span> æŒ‘æˆ˜è€…æ¨¡å‹ (Challenger)
                </span>
            </div>

        </div>

        <!-- Review Panel -->
        <div class="review-panel" style="margin-top: 40px;">
            <div class="panel-tabs" style="display: flex; gap: 20px; border-bottom: 2px solid #eee; margin-bottom: 20px; align-items: center;">
                <h2 @click="activeTab = 'validation'" 
                    :style="{ 
                        borderLeft: '5px solid ' + (activeTab === 'validation' ? '#28a745' : '#ccc'),
                        opacity: activeTab === 'validation' ? 1 : 0.5 
                    }"
                    style="padding-left: 10px; cursor: pointer; margin-bottom: 10px;">
                    ğŸ›¡ï¸ æ¨¡å‹å®æˆ˜å›æµ‹
                </h2>
                <h2 @click="activeTab = 'rawdata'" 
                    :style="{ 
                        borderLeft: '5px solid ' + (activeTab === 'rawdata' ? '#28a745' : '#ccc'), 
                        opacity: activeTab === 'rawdata' ? 1 : 0.5 
                    }"
                    style="padding-left: 10px; cursor: pointer; margin-bottom: 10px;">
                    ğŸ§¬ å…¨æ¯ç”Ÿæ•°æ® (Raw Matrix)
                </h2>
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <h2 @click="activeTab = 'polymarket'" 
                        :style="{ 
                            borderLeft: '5px solid ' + (activeTab === 'polymarket' ? '#6f42c1' : '#ccc'), 
                            opacity: activeTab === 'polymarket' ? 1 : 0.5 
                        }"
                        style="padding-left: 10px; cursor: pointer; margin-bottom: 0;">
                        ğŸ”® å¸‚åœºé¢„æµ‹ (Sentiment)
                    </h2>
                </div>
                
                <h2 @click="activeTab = 'ai_advice'" 
                    :style="{ 
                        borderLeft: '5px solid ' + (activeTab === 'ai_advice' ? '#007bff' : '#ccc'), 
                        opacity: activeTab === 'ai_advice' ? 1 : 0.5 
                    }"
                    style="padding-left: 10px; cursor: pointer; margin-bottom: 10px;">
                    ğŸ¤– AI å»ºè®®
                </h2>
                
                <div style="flex-grow: 1;"></div>
                <button @click="showModal = true" class="export-btn" style="background: #28a745; color: white; border: none; padding: 8px 18px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 0.9em; display: flex; align-items: center; gap: 6px; box-shadow: 0 4px 6px rgba(40, 167, 69, 0.15); margin-bottom: 10px;">
                    ğŸ“¥ ä¸€é”®å¯¼å‡ºé¢„æµ‹
                </button>
            </div>

            <!-- Tabs Content -->
            <div v-show="activeTab === 'validation'">
                <prediction-table :validation-data="validationHistory"></prediction-table>
            </div>

            <div v-show="activeTab === 'rawdata'">
                <raw-data-table :data="rawData" @load-more="loadRaw"></raw-data-table>
            </div>

            <div v-show="activeTab === 'polymarket'">
                <polymarket-grid 
                    :market-data="marketData"
                    :is-syncing="isSyncingMarket"
                    @sync-market="syncMarket"
                ></polymarket-grid>
            </div>

            <div v-show="activeTab === 'ai_advice'">
                <div class="ai-advice-placeholder" style="padding: 40px; text-align: center; background: #f8f9ff; border: 2px dashed #007bff; border-radius: 12px; color: #007bff;">
                    <div style="font-size: 40px; margin-bottom: 15px;">ğŸ§ </div>
                    <h3 style="margin: 0;">AI ç­–ç•¥å¼•æ“å°±ç»ª</h3>
                    <p style="color: #666; margin-top: 10px;">æ­£åœ¨ç­‰å¾…æŒ‡ä»¤ç”Ÿæˆå…·ä½“çš„æˆ˜æœ¯å»ºè®®...</p>
                </div>
            </div>
        </div>
    </div>
{% endraw %}

    <!-- Main Entry Point -->
    <script type="module" src="{{ url_for('static', filename='js/vue_app.js') }}?v={{ range(1, 10000) | random }}"></script>
</body>
</html>
